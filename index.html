<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Performance Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS (Inline SVGs to replace lucide-react) ---
        const Icon = ({ path, color = "currentColor", className = "w-4 h-4" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Upload: (props) => <Icon path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} {...props} />,
            TrendingUp: (props) => <Icon path={<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>} {...props} />,
            BookOpen: (props) => <Icon path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} {...props} />,
            Divide: (props) => <Icon path={<><circle cx="12" cy="6" r="1"/><line x1="5" x2="19" y1="12" y2="12"/><circle cx="12" cy="18" r="1"/></>} {...props} />,
            BrainCircuit: (props) => <Icon path={<><path d="M12 4.5a2.5 2.5 0 0 0-4.96-.46 2.5 2.5 0 0 0-1.98 3 2.5 2.5 0 0 0-1.32 3 2.5 2.5 0 0 0 .38 3.7 2.5 2.5 0 0 0 1.9 2.27V21"/><path d="M12 4.5a2.5 2.5 0 0 1 4.96-.46 2.5 2.5 0 0 1 1.98 3 2.5 2.5 0 0 1 1.32 3 2.5 2.5 0 0 1-.38 3.7 2.5 2.5 0 0 1-1.9 2.27V21"/><path d="M12 13v8"/><path d="M8 21h8"/></>} {...props} />,
            Info: (props) => <Icon path={<><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></>} {...props} />,
        };

        // --- DEMO DATA ---
        const DEMO_CSV = `NAME,CODE,YEAR,Reading 26 Scale Score,Reading 26 Percentile,Reading 25 Scale Score,Reading 25 Percentile,Reading 24 Scale Score,Reading 24 Percentile,Maths 26 Scale Score,Maths 26 Percentile,Maths 25 Scale Score,Maths 25 Percentile,Maths 24 Scale Score,Maths 24 Percentile,AGAT 26 Scale Score,AGAT 26 Percentile,AGAT 25 Scale Score,AGAT 25 Percentile,AGAT 24 Scale Score,AGAT 24 Percentile

"Sample, Year 8",99900001,8,135,60,,,,,125,50,,,,,130,55,,,,
"Test, Year 8",99900002,8,138,65,,,,,128,53,,,,,132,58,,,,
"Sample, Year 9",99900003,9,140,65,,,,,130,55,,,,,135,60,,,,
"Test, Year 9",99900004,9,142,68,,,,,132,58,,,,,137,62,,,,
"Sample, Year 10",99900005,10,145,70,,,,,135,60,,,,,140,65,,,,
"Test, Year 10",99900006,10,148,73,,,,,138,63,,,,,142,68,,,,
"Sample, Year 11",99900007,11,150,75,,,,,140,65,,,,,145,70,,,,
"Test, Year 11",99900008,11,152,78,,,,,142,68,,,,,147,72,,,,
`;

        // --- PLUGIN: Single Point Horizontal Line ---
        const singlePointLinePlugin = {
            id: 'singlePointLine',
            beforeDatasetsDraw: (chart) => {
                const { ctx, chartArea: { left, right }, scales } = chart;
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    if (meta.hidden) return;
                    const validPoints = dataset.data.filter(v => v !== null && v !== undefined && !isNaN(v));
                    if (validPoints.length === 1) {
                        const value = validPoints[0];
                        const yAxisID = dataset.yAxisID || 'y';
                        const yScale = scales[yAxisID];
                        if (!yScale) return;
                        const yPixel = yScale.getPixelForValue(value);
                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(left, yPixel);
                        ctx.lineTo(right, yPixel);
                        ctx.lineWidth = dataset.borderWidth || 3; 
                        ctx.strokeStyle = dataset.borderColor;
                        if (dataset.borderDash) ctx.setLineDash(dataset.borderDash);
                        ctx.stroke();
                        ctx.restore();
                    }
                });
            }
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [selectedYear, setSelectedYear] = useState('');
            const [selectedStudentName, setSelectedStudentName] = useState('');
            const [showPercentiles, setShowPercentiles] = useState(true);
            const [chartData, setChartData] = useState(null);
            const [isFileUploaded, setIsFileUploaded] = useState(false);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // --- PARSING LOGIC ---
            const parseCSV = (csvText) => {
                const cleanText = csvText.replace(/^\ufeff/, '');
                const lines = cleanText.split(/\r?\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) return;

                const splitCSVLine = (line) => {
                    const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
                    return line.split(regex).map(val => val.trim().replace(/^"|"$/g, '').trim());
                };

                const headers = splitCSVLine(lines[0]).map(h => h.trim());

                const parsedData = lines.slice(1).map(line => {
                    const values = splitCSVLine(line);
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    return row;
                });

                const cleanData = parsedData.filter(row => row.NAME && row.YEAR);
                setData(cleanData);
            };

            useEffect(() => {
                parseCSV(DEMO_CSV);
            }, []);

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        parseCSV(e.target.result);
                        setIsFileUploaded(true);
                        setSelectedYear('');
                        setSelectedStudentName('');
                        setChartData(null);
                    };
                    reader.readAsText(file);
                }
            };

            // --- MEMOIZED DATA SELECTORS ---
            const availableYears = useMemo(() => {
                const years = [...new Set(data.map(d => d.YEAR))];
                return years.sort((a, b) => Number(a) - Number(b));
            }, [data]);

            const availableStudents = useMemo(() => {
                if (!selectedYear) return [];
                return data
                    .filter(d => d.YEAR == selectedYear)
                    .sort((a, b) => a.NAME.localeCompare(b.NAME));
            }, [data, selectedYear]);

            const selectedStudent = useMemo(() => {
                return data.find(d => d.NAME === selectedStudentName);
            }, [data, selectedStudentName]);

            const getValue = (student, subject, yearShort, type = 'Scale Score') => {
                if (!student) return null;
                const targetBase = `${subject} ${yearShort} ${type}`.toLowerCase().replace(/\s+/g, '');
                const matchKey = Object.keys(student).find(k => 
                    k.toLowerCase().replace(/\s+/g, '') === targetBase
                );
                const val = matchKey ? student[matchKey] : null;
                return val ? parseFloat(val) : null;
            };

            // --- CHART PREPARATION ---
            useEffect(() => {
                if (!selectedStudent) {
                    setChartData(null);
                    return;
                }

                const years = ['24', '25', '26'];
                const labels = ['2024', '2025', '2026'];

                const readingScores = years.map(y => getValue(selectedStudent, 'Reading', y, 'Scale Score'));
                const mathsScores = years.map(y => getValue(selectedStudent, 'Maths', y, 'Scale Score'));
                const agatScores = years.map(y => getValue(selectedStudent, 'AGAT', y, 'Scale Score'));

                const datasets = [
                    {
                        label: 'Reading (Score)',
                        data: readingScores,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.1,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        spanGaps: true,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Maths (Score)',
                        data: mathsScores,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        spanGaps: true,
                        yAxisID: 'y',
                    },
                    {
                        label: 'AGAT (Score)',
                        data: agatScores,
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.1,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        spanGaps: true,
                        yAxisID: 'y',
                    }
                ];

                if (showPercentiles) {
                    const readingPercentiles = years.map(y => getValue(selectedStudent, 'Reading', y, 'Percentile'));
                    const mathsPercentiles = years.map(y => getValue(selectedStudent, 'Maths', y, 'Percentile'));
                    const agatPercentiles = years.map(y => getValue(selectedStudent, 'AGAT', y, 'Percentile'));

                    datasets.push(
                        {
                            label: 'Reading (PCTL)',
                            data: readingPercentiles,
                            borderColor: 'rgba(239, 68, 68, 0.5)',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.1,
                            pointRadius: 4,
                            pointStyle: 'rectRot',
                            spanGaps: true,
                            yAxisID: 'y1',
                        },
                        {
                            label: 'Maths (PCTL)',
                            data: mathsPercentiles,
                            borderColor: 'rgba(59, 130, 246, 0.5)',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.1,
                            pointRadius: 4,
                            pointStyle: 'rectRot',
                            spanGaps: true,
                            yAxisID: 'y1',
                        },
                        {
                            label: 'AGAT (PCTL)',
                            data: agatPercentiles,
                            borderColor: 'rgba(16, 185, 129, 0.5)',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.1,
                            pointRadius: 4,
                            pointStyle: 'rectRot',
                            spanGaps: true,
                            yAxisID: 'y1',
                        },
                        {
                            label: 'National Average (50th)',
                            data: [50, 50, 50],
                            borderColor: 'rgba(156, 163, 175, 0.8)',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [6, 4],
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            yAxisID: 'y1',
                            order: 99
                        }
                    );
                }

                setChartData({ labels, datasets });

            }, [selectedStudent, showPercentiles]);

            // --- CHART RENDERING (Chart.js Native) ---
            useEffect(() => {
                if (!chartData || !chartRef.current) return;

                // Destroy old instance
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    boxWidth: 20,
                                    font: { family: "'Inter', sans-serif", size: 11 }
                                }
                            },
                            title: { display: false },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                titleColor: '#1f2937',
                                bodyColor: '#4b5563',
                                borderColor: '#e5e7eb',
                                borderWidth: 1,
                                padding: 12,
                                titleFont: { size: 14, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Scale Score',
                                    font: { weight: 'bold' }
                                },
                                grid: { color: '#f3f4f6' },
                                suggestedMin: 100,
                            },
                            y1: {
                                type: 'linear',
                                display: showPercentiles,
                                position: 'right',
                                min: 0,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Percentile',
                                    font: { weight: 'bold' }
                                },
                                grid: { drawOnChartArea: false },
                            },
                            x: { grid: { display: false } }
                        }
                    },
                    plugins: [singlePointLinePlugin]
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [chartData, showPercentiles]);


            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-4 md:p-8">
                    <div className="max-w-5xl mx-auto space-y-6">
                        
                        {/* Header */}
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                                    <Icons.TrendingUp className="w-6 h-6 text-blue-600" />
                                    Student Performance Tracker
                                </h1>
                                <p className="text-slate-500 mt-1">Visualize longitudinal growth (Scale) and comparison (Percentile).</p>
                            </div>
                            
                            <div className="mt-4 md:mt-0 flex items-center gap-3">
                                <label className="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg cursor-pointer transition-colors text-sm font-medium">
                                    <Icons.Upload className="w-4 h-4" />
                                    {isFileUploaded ? 'Upload Different File' : 'Upload Full Data CSV'}
                                    <input 
                                        type="file" 
                                        accept=".csv"
                                        onChange={handleFileUpload}
                                        className="hidden" 
                                    />
                                </label>
                            </div>
                        </div>

                        {/* Demo Data Notice */}
                        {!isFileUploaded && (
                            <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 flex gap-3 text-sm text-amber-800">
                                <Icons.Info className="w-5 h-5 flex-shrink-0" />
                                <p>
                                    <strong>Preview Mode:</strong> Showing sample data. 
                                    Upload your "Master.csv" file to see the complete student list.
                                </p>
                            </div>
                        )}

                        {/* Controls */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                <label className="block text-sm font-semibold text-slate-700 mb-2">1. Select Year Level</label>
                                <div className="relative">
                                    <select 
                                        value={selectedYear}
                                        onChange={(e) => {
                                            setSelectedYear(e.target.value);
                                            setSelectedStudentName('');
                                        }}
                                        className="w-full pl-3 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="">-- Choose Year --</option>
                                        {availableYears.map(year => (
                                            <option key={year} value={year}>Year {year}</option>
                                        ))}
                                    </select>
                                    <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-400">
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                <label className="block text-sm font-semibold text-slate-700 mb-2">2. Select Student</label>
                                <div className="relative">
                                    <select 
                                        value={selectedStudentName}
                                        onChange={(e) => setSelectedStudentName(e.target.value)}
                                        disabled={!selectedYear}
                                        className={`w-full pl-3 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${!selectedYear ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    >
                                        <option value="">-- Choose Student --</option>
                                        {availableStudents.map(student => (
                                            <option key={student.NAME} value={student.NAME}>{student.NAME}</option>
                                        ))}
                                    </select>
                                    <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-400">
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Main Content Area */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            
                            {/* Chart Panel */}
                            <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-100 min-h-[400px]">
                                {/* Chart Toolbar */}
                                <div className="flex justify-end mb-4 border-b border-slate-100 pb-2">
                                    <label className="inline-flex items-center cursor-pointer gap-2 select-none text-sm text-slate-600 hover:text-slate-900 transition-colors">
                                        <input 
                                            type="checkbox" 
                                            checked={showPercentiles}
                                            onChange={(e) => setShowPercentiles(e.target.checked)}
                                            className="w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500"
                                        />
                                        <span>Show Percentiles (Dashed Lines)</span>
                                    </label>
                                </div>

                                {chartData ? (
                                    <div className="h-[350px] w-full">
                                        <canvas ref={chartRef}></canvas>
                                    </div>
                                ) : (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-400 py-12">
                                        <Icons.TrendingUp className="w-16 h-16 mb-4 opacity-20" />
                                        <p>Select a Year and Student to view their graph.</p>
                                    </div>
                                )}
                            </div>

                            {/* Stats / Legend Panel */}
                            <div className="lg:col-span-1 space-y-4">
                                {chartData ? (
                                    <>
                                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                                            <h3 className="font-semibold text-slate-800 mb-4 border-b pb-2">Latest Performance (2026)</h3>
                                            <div className="space-y-4">
                                                <ScoreCard 
                                                    icon={<Icons.BookOpen className="w-4 h-4 text-red-500" />}
                                                    label="Reading" 
                                                    value={getValue(selectedStudent, 'Reading', '26', 'Percentile')} 
                                                    subValue={getValue(selectedStudent, 'Reading', '26', 'Scale Score')}
                                                    color="text-red-600"
                                                    bg="bg-red-50"
                                                />
                                                <ScoreCard 
                                                    icon={<Icons.Divide className="w-4 h-4 text-blue-500" />}
                                                    label="Maths" 
                                                    value={getValue(selectedStudent, 'Maths', '26', 'Percentile')} 
                                                    subValue={getValue(selectedStudent, 'Maths', '26', 'Scale Score')}
                                                    color="text-blue-600"
                                                    bg="bg-blue-50"
                                                />
                                                <ScoreCard 
                                                    icon={<Icons.BrainCircuit className="w-4 h-4 text-emerald-500" />}
                                                    label="AGAT" 
                                                    value={getValue(selectedStudent, 'AGAT', '26', 'Percentile')} 
                                                    subValue={getValue(selectedStudent, 'AGAT', '26', 'Scale Score')}
                                                    color="text-emerald-600"
                                                    bg="bg-emerald-50"
                                                />
                                            </div>
                                        </div>
                                        
                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                            <p className="text-xs text-blue-700 leading-relaxed">
                                                <strong>Note:</strong> Solid lines indicate Scale Scores (left axis). 
                                                {showPercentiles ? ' Dashed lines indicate Percentiles (right axis).' : ''}
                                            </p>
                                        </div>
                                    </>
                                ) : (
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 h-full flex items-center justify-center">
                                        <p className="text-slate-400 text-sm text-center">Student details will appear here.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ScoreCard = ({ icon, label, value, subValue, color, bg }) => (
            <div className="flex items-center justify-between p-3 rounded-lg border border-slate-100 hover:shadow-sm transition-shadow">
                <div className="flex items-center gap-3">
                    <div className={`p-2 rounded-md ${bg}`}>
                        {icon}
                    </div>
                    <div>
                        <span className="text-slate-600 font-medium block">{label}</span>
                        <span className="text-[10px] uppercase text-slate-400 tracking-wider">Percentile & Score</span>
                    </div>
                </div>
                <div className="text-right">
                    <div className={`text-lg font-bold ${value ? color : 'text-slate-300'}`}>
                        {value ? value + '%' : '-'}
                    </div>
                    {subValue !== null && (
                        <div className="text-xs font-semibold text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded inline-block">
                            Score: {subValue}
                        </div>
                    )}
                </div>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>

